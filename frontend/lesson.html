<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <h1>SpeakUpEngBot</h1>
        <nav>
            <a href="index.html">Lessons</a>
            <a href="chat.html">Chat</a>
            <a href="profile.html">Profile</a>
        </nav>
    </header>
    <div class="container">
        <h2 id="lesson-title"></h2>
        <div id="lesson-description" class="markdown-body"></div>
        <p id="lesson-status"></p>
        <div id="tests-list"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('lessonId');
        const userId = checkAuth();

        let currentTestIndex = 0;
        let tests = [];

        if (userId && lessonId) {
            apiRequest(`lessons/${lessonId}?userId=${userId}`)
                .then(lesson => {
                    document.getElementById('lesson-title').textContent = `${lesson.title} (${lesson.level})`;
                    document.getElementById('lesson-description').innerHTML = parseMarkdownV2(lesson.description);
                    document.getElementById('lesson-status').textContent = lesson.completed ? '‚úÖ Completed' : '';
                    tests = lesson.tests;
                    if (tests.length > 0) {
                        showTest(currentTestIndex);
                    } else {
                        document.getElementById('tests-list').textContent = 'No tests available.';
                    }
                });
        }

        function showTest(index) {
            if (index >= tests.length) {
                document.getElementById('tests-list').innerHTML = '<p>Lesson completed! üéâ</p>';
                return;
            }
            const test = tests[index];
            const testsList = document.getElementById('tests-list');
            testsList.innerHTML = `
                <h3>Test ${index + 1}</h3>
                <div class="markdown-body">${parseMarkdownV2(test.question)}</div>
                <div id="options"></div>
            `;
            const optionsDiv = document.getElementById('options');
            test.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'test-option';
                optionDiv.innerHTML = parseMarkdownV2(option);
                optionDiv.onclick = () => submitAnswer(index, option);
                optionsDiv.appendChild(optionDiv);
            });
        }

        function submitAnswer(testIndex, answer) {
            apiRequest(`lessons/${lessonId}/tests/${testIndex}`, 'POST', { userId, answer })
                .then(result => {
                    alert(`Answer ${result.isCorrect ? 'Correct! ‚úÖ' : 'Incorrect! ‚ùå'} ${result.xpChange ? `XP: ${result.xpChange}` : ''}`);
                    if (result.isCorrect) {
                        currentTestIndex++;
                        showTest(currentTestIndex);
                    }
                });
        }
    </script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'937f8fb7aa5219c0',t:'MTc0NTkzNzY5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>